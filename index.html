<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CredChain | Credential Verification</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;600;700&family=Great+Vibes&display=swap" rel="stylesheet" />

  <style>
    :root{
      --ink:#0b1220;
      --muted:#51607a;
      --brand:#1d4ed8;
      --brand2:#3b82f6;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --paper:#fbfaf6;
      --paper2:#f6f4ee;
      --gold1:#caa34d;
      --gold2:#f6d77a;
      --line:#e6e1d2;
    }

    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* Background (premium + subtle) */
    .bg-premium{
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 30%, rgba(202,163,77,.16), transparent 60%),
        linear-gradient(180deg, #f8fafc 0%, #f3f4f6 100%);
      min-height: 100vh;
    }

    /* Top search bar card (glass-ish) */
    .topbar{
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow:
        0 20px 60px rgba(15,23,42,.08),
        0 6px 16px rgba(15,23,42,.06);
    }

    /* Certificate frame */
    .cert-wrap{
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      box-shadow:
        0 40px 110px rgba(2,6,23,.15),
        0 10px 26px rgba(2,6,23,.10);
      background: var(--paper);
    }

    /* Paper texture + watermark */
    .cert-paper{
      position: relative;
      background:
        radial-gradient(700px 420px at 15% 15%, rgba(29,78,216,.07), transparent 60%),
        radial-gradient(650px 420px at 85% 25%, rgba(202,163,77,.10), transparent 60%),
        linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
    }
    .cert-paper:before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(10,18,32,.02) 0, rgba(10,18,32,.02) 1px, transparent 1px, transparent 6px),
        repeating-linear-gradient(90deg, rgba(10,18,32,.015) 0, rgba(10,18,32,.015) 1px, transparent 1px, transparent 7px);
      opacity:.35;
      pointer-events:none;
    }
    .cert-paper:after{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 50% 40%, rgba(29,78,216,.10), transparent 52%),
        radial-gradient(circle at 50% 40%, rgba(202,163,77,.12), transparent 58%);
      filter: blur(0px);
      opacity:.22;
      pointer-events:none;
      transform: rotate(-8deg);
    }

    /* Double border + inner stroke */
    .cert-border{
      position:absolute; inset:18px;
      border-radius: 14px;
      border: 2px solid rgba(202,163,77,.65);
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.08);
      pointer-events:none;
    }
    .cert-border2{
      position:absolute; inset:30px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.10);
      pointer-events:none;
    }

    /* Corner ornaments (simple SVG) */
    .corner{
      position:absolute;
      width:72px; height:72px;
      opacity:.85;
      pointer-events:none;
      filter: drop-shadow(0 2px 2px rgba(2,6,23,.12));
    }
    .corner.tl{top:18px; left:18px;}
    .corner.tr{top:18px; right:18px; transform: scaleX(-1);}
    .corner.bl{bottom:18px; left:18px; transform: scaleY(-1);}
    .corner.br{bottom:18px; right:18px; transform: scale(-1);}

    /* Typography */
    .font-cert-title{font-family:'Cinzel', serif;}
    .font-script{font-family:'Great Vibes', cursive;}

    /* Gold divider */
    .gold-rule{
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(202,163,77,.95), transparent);
    }

    /* Fancy badge */
    .shield{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.35rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      font-size: 12px;
      color: rgba(11,18,32,.92);
      white-space: nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;}
    .dot.good{background:var(--good);}
    .dot.warn{background:var(--warn);}
    .dot.bad{background:var(--bad);}

    /* Embossed seal */
    .seal{
      width: 92px; height: 92px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.0) 42%),
        radial-gradient(circle at 60% 70%, rgba(0,0,0,.06), transparent 55%),
        linear-gradient(135deg, rgba(246,215,122,.95), rgba(202,163,77,.95));
      box-shadow:
        inset 0 0 0 3px rgba(255,255,255,.35),
        inset 0 0 0 10px rgba(202,163,77,.25),
        0 18px 26px rgba(2,6,23,.10);
      display:flex; align-items:center; justify-content:center;
      position: relative;
    }
    .seal:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:999px;
      border: 1px dashed rgba(11,18,32,.18);
      opacity:.7;
    }

    /* Small code box */
    .codebox{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      border-radius: 12px;
      padding: .75rem .9rem;
      box-shadow: 0 10px 20px rgba(2,6,23,.05);
    }

    /* Loading spinner */
    .spin-ring{
      width: 54px; height: 54px;
      border-radius: 999px;
      border: 3px solid rgba(29,78,216,.12);
      border-top-color: rgba(29,78,216,.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeIn{
      from{opacity:0; transform: translateY(10px)}
      to{opacity:1; transform: translateY(0)}
    }
    .fade-in{animation: fadeIn .35s ease-out;}

    /* Print */
    .print-only{display:none;}
    @media print{
      .no-print{display:none !important;}
      .print-only{display:block;}
      body{background:white !important; padding:0 !important; margin:0 !important;}
      .bg-premium{background:white !important;}
      .cert-wrap{box-shadow:none !important; border-radius:0 !important;}
      .cert-border, .cert-border2{display:none;}
      .corner{display:none;}
      @page { size: A4; margin: 10mm; }
    }
  </style>
</head>

<body class="bg-premium p-4">
  <!-- Header / Search -->
  <div class="no-print max-w-5xl mx-auto mb-8">
    <div class="topbar rounded-2xl p-6">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl flex items-center justify-center"
               style="background: linear-gradient(135deg, var(--brand2), var(--brand)); box-shadow: 0 10px 20px rgba(29,78,216,.25);">
            <i class="fas fa-shield-halved text-white text-lg"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-900">CredChain Verification</h1>
            <p class="text-gray-600 text-sm">Instant certificate validation • registry + blockchain</p>
          </div>
        </div>

        <div class="flex-1 w-full md:max-w-xl">
          <div class="relative">
            <input
              id="credentialId"
              type="text"
              placeholder="Paste credential ID or verification link…"
              class="w-full rounded-xl px-4 py-3 pr-28 focus:outline-none"
              style="border:1px solid rgba(15,23,42,.12); box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);"
              value=""
            />
            <button
              onclick="verifyCredential()"
              class="absolute right-2 top-2 text-white px-5 py-2 rounded-xl transition text-sm font-semibold"
              style="background: linear-gradient(135deg, var(--brand2), var(--brand)); box-shadow: 0 12px 18px rgba(29,78,216,.22);"
              id="verifyBtn"
            >
              Verify
            </button>
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mt-2">
            <p class="text-xs text-gray-500">
              Example:
              <code class="text-blue-700 bg-blue-50 px-2 py-0.5 rounded">fd9acfcd-9602-4cc5-8612-b84f4c48383c</code>
              <button onclick="useExample()" class="text-blue-700 hover:text-blue-900 ml-2 font-semibold">Try it</button>
            </p>
            <p class="text-xs text-gray-500 flex items-center gap-2">
              <i class="fas fa-lock text-gray-400"></i>
              No login needed • public verification only
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-4xl mx-auto">
    <!-- Loading -->
    <div id="loading" class="hidden text-center py-14">
      <div class="inline-flex flex-col items-center">
        <div class="spin-ring mb-4"></div>
        <p class="text-gray-800 font-semibold">Verifying credential…</p>
        <p class="text-gray-500 text-sm mt-1">Checking issuer registry and blockchain proof</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden fade-in mb-6 rounded-2xl p-4"
         style="background: rgba(254,242,242,.9); border: 1px solid rgba(239,68,68,.22); box-shadow: 0 12px 28px rgba(239,68,68,.08);">
      <div class="flex items-start gap-3">
        <i class="fas fa-triangle-exclamation text-red-500 mt-1"></i>
        <div class="flex-1">
          <p class="text-red-800 font-semibold" id="errorText"></p>
          <button onclick="hideError()" class="text-red-700 hover:text-red-900 text-sm mt-2 font-semibold">Dismiss</button>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div id="result" class="hidden fade-in">
      <div class="cert-wrap">
        <div class="cert-paper">
          <!-- ornaments -->
          <svg class="corner tl" viewBox="0 0 100 100" aria-hidden="true">
            <path d="M8,52 C22,22 42,12 58,10 C72,8 84,12 92,18" fill="none" stroke="rgba(202,163,77,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M10,62 C18,40 36,28 52,24" fill="none" stroke="rgba(15,23,42,.18)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="24" cy="40" r="4" fill="rgba(202,163,77,.85)"/>
            <circle cx="40" cy="28" r="3" fill="rgba(15,23,42,.22)"/>
          </svg>
          <svg class="corner tr" viewBox="0 0 100 100" aria-hidden="true">
            <path d="M8,52 C22,22 42,12 58,10 C72,8 84,12 92,18" fill="none" stroke="rgba(202,163,77,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M10,62 C18,40 36,28 52,24" fill="none" stroke="rgba(15,23,42,.18)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="24" cy="40" r="4" fill="rgba(202,163,77,.85)"/>
            <circle cx="40" cy="28" r="3" fill="rgba(15,23,42,.22)"/>
          </svg>
          <svg class="corner bl" viewBox="0 0 100 100" aria-hidden="true">
            <path d="M8,52 C22,22 42,12 58,10 C72,8 84,12 92,18" fill="none" stroke="rgba(202,163,77,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M10,62 C18,40 36,28 52,24" fill="none" stroke="rgba(15,23,42,.18)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="24" cy="40" r="4" fill="rgba(202,163,77,.85)"/>
            <circle cx="40" cy="28" r="3" fill="rgba(15,23,42,.22)"/>
          </svg>
          <svg class="corner br" viewBox="0 0 100 100" aria-hidden="true">
            <path d="M8,52 C22,22 42,12 58,10 C72,8 84,12 92,18" fill="none" stroke="rgba(202,163,77,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M10,62 C18,40 36,28 52,24" fill="none" stroke="rgba(15,23,42,.18)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="24" cy="40" r="4" fill="rgba(202,163,77,.85)"/>
            <circle cx="40" cy="28" r="3" fill="rgba(15,23,42,.22)"/>
          </svg>

          <div class="cert-border"></div>
          <div class="cert-border2"></div>

          <div class="relative px-6 sm:px-12 py-10 sm:py-12">
            <!-- Top row (logos + heading) -->
            <div class="flex items-center justify-between gap-4">
              <!-- Left logo placeholder -->
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                     style="background: rgba(29,78,216,.08); border:1px solid rgba(29,78,216,.18);">
                  <span class="font-cert-title font-bold" style="color: var(--brand);">NUST</span>
                </div>
                <div class="hidden sm:block">
                  <p class="text-sm font-semibold" style="color: var(--ink);">National University of</p>
                  <p class="text-sm font-semibold" style="color: var(--ink);">Science & Technology</p>
                </div>
              </div>

              <div class="text-center">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full"
                     style="background: rgba(29,78,216,.08); border:1px solid rgba(29,78,216,.12);">
                  <i class="fas fa-shield-check" style="color: var(--brand);"></i>
                  <span class="text-xs font-bold tracking-widest uppercase" style="color: var(--brand);">CREDCHAIN VERIFIED</span>
                </div>
              </div>

              <!-- Right logo placeholder -->
              <div class="flex items-center gap-3">
                <div class="hidden sm:block text-right">
                  <p class="text-sm font-semibold" style="color: var(--ink);">CCE Consulting</p>
                  <p class="text-sm font-semibold" style="color: var(--ink);">Group</p>
                </div>
                <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                     style="background: rgba(202,163,77,.10); border:1px solid rgba(202,163,77,.22);">
                  <span class="font-cert-title font-bold" style="color: #9a7b2f;">CCE</span>
                </div>
              </div>
            </div>

            <div class="mt-8 text-center">
              <h1 class="font-cert-title text-3xl sm:text-4xl font-bold tracking-wide" style="color: var(--ink);">
                CERTIFICATE OF PROFICIENCY
              </h1>
              <p class="mt-2 text-sm sm:text-base" style="color: var(--muted);">
                This is to certify that the individual named below has successfully completed the stated programme.
              </p>

              <div class="mt-6 gold-rule mx-auto w-56"></div>
            </div>

            <!-- Status shields (web only) -->
            <div class="no-print mt-8 flex flex-wrap items-center justify-center gap-3">
              <span class="shield" id="badgeRegistry">
                <span class="dot good" id="dotRegistry"></span>
                <span class="font-semibold">Registry</span>
                <span class="opacity-70" id="txtRegistry">Verified</span>
              </span>

              <span class="shield" id="badgeOnChain">
                <span class="dot warn" id="dotOnChain"></span>
                <span class="font-semibold">On-Chain</span>
                <span class="opacity-70" id="txtOnChain">Checking…</span>
              </span>

              <span class="shield" id="badgeIntegrity">
                <span class="dot warn" id="dotIntegrity"></span>
                <span class="font-semibold">Integrity</span>
                <span class="opacity-70" id="txtIntegrity">Checking…</span>
              </span>

              <button onclick="printCertificate()"
                      class="shield hover:shadow-md transition font-semibold"
                      style="border:1px solid rgba(29,78,216,.22); color: var(--brand);">
                <i class="fas fa-print"></i> Print
              </button>
            </div>

            <!-- Recipient -->
            <div class="mt-10 text-center">
              <p class="text-sm uppercase tracking-widest" style="color: rgba(81,96,122,.9);">
                Presented To
              </p>
              <h2 id="learnerName" class="font-script text-5xl sm:text-6xl mt-3" style="color: var(--ink);">
                —
              </h2>
              <div class="mt-5 gold-rule mx-auto w-64"></div>
            </div>

            <!-- Programme -->
            <div class="mt-10 text-center max-w-2xl mx-auto">
              <p class="text-sm uppercase tracking-widest" style="color: rgba(81,96,122,.9);">
                Programme / Qualification
              </p>
              <h3 id="credentialTitle" class="mt-2 text-xl sm:text-2xl font-semibold" style="color: var(--ink);">
                —
              </h3>

              <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-6">
                <div class="text-center">
                  <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.85);">Issued by</p>
                  <p id="institutionName" class="mt-1 font-semibold" style="color: var(--ink);">—</p>
                </div>
                <div class="hidden sm:block" style="width:1px;height:32px;background: rgba(15,23,42,.12);"></div>
                <div class="text-center">
                  <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.85);">Date Issued</p>
                  <p id="issuedDate" class="mt-1 font-semibold" style="color: var(--ink);">—</p>
                </div>
              </div>
            </div>

            <!-- Divider -->
            <div class="mt-10 gold-rule mx-auto w-full max-w-3xl"></div>

            <!-- Details + Seal -->
            <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
              <div class="md:col-span-2 space-y-4">
                <div class="codebox">
                  <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Credential ID</p>
                  <p id="credentialIdDisplay" class="mt-1 font-mono text-sm font-semibold break-all" style="color: var(--ink);">—</p>
                </div>

                <div class="codebox">
                  <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Verification ID (Public)</p>
                  <p id="verificationId" class="mt-1 font-mono text-sm font-semibold break-all" style="color: var(--ink);">—</p>
                </div>

                <!-- Blockchain panel -->
                <div class="codebox no-print">
                  <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-link" style="color: var(--brand);"></i>
                      <p class="font-semibold" style="color: var(--ink);">Blockchain Proof</p>
                    </div>
                    <div id="blockchainStatus"></div>
                  </div>

                  <div class="mt-3 p-3 rounded-xl" style="background: rgba(255,255,255,.75); border:1px solid rgba(15,23,42,.10);">
                    <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Signature / Hash</p>
                    <code id="blockchainHash" class="block mt-1 text-xs font-mono break-all" style="color: rgba(11,18,32,.92);">—</code>
                  </div>

                  <p class="mt-2 text-xs" style="color: rgba(81,96,122,.9);">
                    <i class="fas fa-clock mr-1"></i>
                    Verified on <span id="verificationTime">—</span>
                  </p>
                </div>
              </div>

              <div class="md:col-span-1 flex flex-col items-center">
                <div class="seal" title="CredChain Certified">
                  <div class="text-center">
                    <i class="fas fa-certificate text-white text-2xl"></i>
                    <p class="mt-1 text-xs font-bold tracking-widest uppercase text-white">CREDCHAIN</p>
                  </div>
                </div>
                <p class="mt-3 text-xs text-center px-6" style="color: rgba(81,96,122,.95);">
                  Cryptographically signed and tamper-evident verification.
                </p>
              </div>
            </div>

            <!-- Signature row -->
            <div class="mt-12 grid grid-cols-1 sm:grid-cols-3 gap-6 items-end">
              <div class="text-center sm:text-left">
                <div class="mx-auto sm:mx-0" style="height:1px;background: rgba(15,23,42,.18); max-width: 240px;"></div>
                <p class="mt-2 text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Authorised Signature</p>
              </div>

              <div class="text-center">
                <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Digital Registry</p>
                <p class="text-sm font-semibold" style="color: var(--ink);">CredChain Verification Portal</p>
              </div>

              <div class="text-center sm:text-right">
                <div class="mx-auto sm:ml-auto sm:mr-0" style="height:1px;background: rgba(15,23,42,.18); max-width: 240px;"></div>
                <p class="mt-2 text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Institution Stamp</p>
              </div>
            </div>

            <!-- Print-only blockchain -->
            <div class="print-only mt-10 pt-6" style="border-top: 1px solid rgba(15,23,42,.15);">
              <div class="text-center">
                <p class="text-sm font-semibold" style="color: var(--ink);">Blockchain Certified</p>
                <div class="mt-3" style="background: #f3f4f6; border: 1px solid rgba(15,23,42,.12); border-radius: 10px; padding: 10px;">
                  <p class="text-xs uppercase tracking-widest" style="color: rgba(81,96,122,.9);">Digital Signature</p>
                  <code id="blockchainHashPrint" class="block mt-1 text-xs font-mono break-all" style="color: var(--ink);">—</code>
                </div>
                <p class="text-xs mt-3" style="color: rgba(81,96,122,.95);">
                  This certificate is cryptographically signed and recorded on an immutable blockchain.
                </p>
              </div>
            </div>

            <!-- Footer microtext -->
            <div class="mt-10 text-center">
              <p class="text-xs" style="color: rgba(81,96,122,.9);">
                To validate: enter the public verification ID on this portal or share the link. Any tampering will fail integrity checks.
              </p>
            </div>

          </div>
        </div>
      </div>

      <!-- Simple status (kept for compatibility, hidden) -->
      <div class="hidden">
        <div id="statusDot"></div>
        <div id="statusText"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="no-print mt-8 text-center">
      <p class="text-sm text-gray-500">
        <i class="fas fa-shield-alt text-blue-600 mr-1"></i>
        Powered by CredChain • Blockchain Verified Credentials
      </p>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080';

    function getPublicIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('publicId') || '';
    }

    document.addEventListener('DOMContentLoaded', function () {
      const publicId = getPublicIdFromUrl();
      if (publicId) {
        document.getElementById('credentialId').value = publicId;
        setTimeout(() => verifyCredential(), 600);
      }
    });

    function useExample() {
      document.getElementById('credentialId').value = 'fd9acfcd-9602-4cc5-8612-b84f4c48383c';
    }

    async function verifyCredential() {
      const input = document.getElementById('credentialId').value.trim();
      if (!input) {
        showError('Please enter a credential ID to verify');
        return;
      }

      let publicId = input;
      if (input.includes('publicId=')) {
        try {
          const url = new URL(input);
          publicId = url.searchParams.get('publicId') || input;
        } catch (e) {}
      }

      showLoading();
      hideError();
      hideResult();

      try {
        const apiResponse = await verifyWithAPI(publicId);
        const blockchainProof = await getBlockchainProof(publicId);
        displayResults(apiResponse, blockchainProof, publicId);
      } catch (error) {
        showError('Verification failed: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    async function verifyWithAPI(publicId) {
      const response = await fetch(`${API_BASE_URL}/api/public/verify/${encodeURIComponent(publicId)}`, {
        method: 'GET',
        headers: { Accept: 'application/json', 'Content-Type': 'application/json' }
      });

      if (!response.ok) {
        if (response.status === 404) throw new Error('Credential not found in registry');
        if (response.status === 400) throw new Error('Invalid credential ID format');
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || `Server error: ${response.status}`);
      }

      return await response.json();
    }

    async function getBlockchainProof(publicId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/public/blockchain/proof/${encodeURIComponent(publicId)}`, {
          method: 'GET',
          headers: { Accept: 'application/json', 'Content-Type': 'application/json' }
        });

        if (response.ok) return await response.json();

        return { existsOnChain: false, active: false, hashMatch: false, credentialHash: null, error: 'Blockchain verification unavailable' };
      } catch (error) {
        return { existsOnChain: false, active: false, hashMatch: false, credentialHash: null, error: error.message };
      }
    }

    function displayResults(apiData, blockchainProof, publicId) {
      const resultDiv = document.getElementById('result');

      // Fields
      document.getElementById('learnerName').textContent = apiData.learnerFullName || 'Credential Holder';
      document.getElementById('institutionName').textContent = apiData.institutionName || 'Issuing Institution';
      document.getElementById('credentialTitle').textContent = apiData.title || 'Credential';
      document.getElementById('issuedDate').textContent = formatDate(apiData.issuedAt) || 'Not specified';
      document.getElementById('credentialIdDisplay').textContent = apiData.credentialNumber || (publicId.substring(0, 24) + '…');
      document.getElementById('verificationId').textContent = publicId;
      document.getElementById('verificationTime').textContent = new Date().toLocaleDateString();

      // Hash
      const hash = blockchainProof.credentialHash || blockchainProof.hash;
      document.getElementById('blockchainHash').textContent = hash || 'Not recorded on blockchain';
      document.getElementById('blockchainHashPrint').textContent = hash || 'Not recorded on blockchain';

      // Badge logic (3 shields)
      const registryValid = !!apiData.valid;

      const existsOnChain = !!(blockchainProof.existsOnChain);
      const active = blockchainProof.active === undefined ? true : !!blockchainProof.active;
      const hashMatch = blockchainProof.hashMatch === undefined ? (existsOnChain ? true : false) : !!blockchainProof.hashMatch;

      setShield('Registry', registryValid, 'dotRegistry', 'txtRegistry');
      setShield('On-Chain', existsOnChain && active, 'dotOnChain', 'txtOnChain', existsOnChain ? (active ? 'Active' : 'Revoked') : 'Not found');
      setShield('Integrity', hashMatch, 'dotIntegrity', 'txtIntegrity', hashMatch ? 'Hash match' : 'Mismatch');

      // Blockchain status chip
      const blockchainStatus = document.getElementById('blockchainStatus');
      blockchainStatus.innerHTML = existsOnChain
        ? `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold"
                 style="background: rgba(22,163,74,.10); color: rgba(20,83,45,.95); border:1px solid rgba(22,163,74,.18);">
              <span style="width:8px;height:8px;border-radius:999px;background: rgba(22,163,74,.95);"></span>
              Recorded on-chain
           </span>`
        : `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold"
                 style="background: rgba(245,158,11,.12); color: rgba(120,53,15,.95); border:1px solid rgba(245,158,11,.22);">
              <span style="width:8px;height:8px;border-radius:999px;background: rgba(245,158,11,.95);"></span>
              Not on-chain
           </span>`;

      // Overall validity (what you show to users)
      const overallValid = registryValid && existsOnChain && active && hashMatch;

      // Keep compatibility IDs (hidden), but set anyway
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      if (overallValid) {
        statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
        statusText.textContent = '✓ Verified on blockchain';
      } else if (registryValid && (!existsOnChain || !hashMatch || !active)) {
        statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500';
        statusText.textContent = 'Issuer verified (check on-chain / integrity status)';
      } else {
        statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
        statusText.textContent = '✗ Verification failed';
      }

      // Show + URL update
      resultDiv.style.display = 'block';

      if (window.history.pushState) {
        const newUrl = `${window.location.origin}${window.location.pathname}?publicId=${encodeURIComponent(publicId)}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
      }

      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function setShield(label, ok, dotId, txtId, overrideText) {
      const dot = document.getElementById(dotId);
      const txt = document.getElementById(txtId);

      if (!dot || !txt) return;

      if (ok) {
        dot.className = 'dot good';
        txt.textContent = overrideText || 'Verified';
      } else {
        dot.className = 'dot warn';
        txt.textContent = overrideText || 'Review';
      }
    }

    function formatDate(dateString) {
      if (!dateString) return null;
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return dateString;
      }
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying';
      btn.style.opacity = '.95';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      const btn = document.getElementById('verifyBtn');
      btn.disabled = false;
      btn.innerHTML = 'Verify';
      btn.style.opacity = '1';
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      document.getElementById('errorText').textContent = message;
      errorDiv.style.display = 'block';
      errorDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    function hideResult() {
      document.getElementById('result').style.display = 'none';
    }

    function printCertificate() {
      window.print();
    }
  </script>
</body>
</html>
